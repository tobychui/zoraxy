<div class="standardContainer">
    <div class="ui basic segment">
        <h2>Static Web Server</h2>
        <p>A simple static web server that serve html css and js files</p>
    </div>
    <div class="ui divider"></div>
    <div class="ui basic segment webservRunningStateWrapper">
        <h4 class="ui header" id="webservRunningState">
            <i class="green circle icon"></i>
            <div class="content">
                <span class="webserv_status">Running</span>
                <div class="sub header">Listen port :<span class="webserv_port">8081</span></div>
            </div>
        </h4>
    </div>
    <div>
        <h3>Web Server Settings</h3>
        <div class="ui form">
            <div class="inline field">
                <div class="ui toggle checkbox webservRootDisabled">
                    <input id="webserv_enable" type="checkbox" class="hidden">
                    <label>Enable Static Web Server</label>
                </div>
            </div>
            <div class="inline field">
                <div class="ui toggle checkbox">
                    <input id="webserv_enableDirList" type="checkbox" class="hidden">
                    <label>Enable Directory Listing</label>
                    <small>If this folder do not contains any index files, list the directory of this folder.</small>
                </div>
            </div>
            <div class="inline field">
                <div class="ui toggle checkbox">
                    <input id="webserv_enableAllInterfaces" type="checkbox" class="hidden">
                    <label>Listening to All Interfaces</label>
                    <small>When disabled, the web server will only listen to localhost (127.0.0.1) and only reachable via reverse proxy rules.</small>
                </div>
            </div>
            <div class="field">
                <label>Document Root Folder</label>
                <input id="webserv_docRoot" type="text" readonly="true">
                <small>
                    The web server root folder can only be changed via startup flags of zoraxy for security reasons. 
                    See the -webserv flag for more details.
                </small>
            </div>
            <div class="field webservRootDisabled">
                <label>Port Number</label>
                <input id="webserv_listenPort" type="number" step="1" min="0" max="65535" value="8081" onchange="updateWebServLinkExample(this.value);">
                <small>Use <code>http://127.0.0.1:<span class="webserv_port">8081</span></code> in proxy rules to access the web server</small>
            </div>
        </div>
    </div>
    <small><i class="ui blue save icon"></i> Changes are saved automatically</small>
    <br>
    <div class="ui message">
        <div class="ui accordion webservhelp">
            <div class="title">
                <i class="dropdown icon"></i>
                How to access the static web server?
            </div>
            <div class="content">
                There are three ways to access the static web server. <br>
                <div class="ui ordered list">
                    <div class="item">
                        If you are using Zoraxy as your gateway reverse proxy server, 
                        you can add a new subdomain proxy rule that points to 
                        <a>http://127.0.0.1:<span class="webserv_port">8081</span></a>
                    </div>
                    <div class="item">
                        If you are using Zoraxy under another reverse proxy server, 
                        add <a>http://127.0.0.1:<span class="webserv_port">8081</span></a> to the config of your upper layer reverse proxy server's config file. 
                    </div>
                    <div class="item">
                        Directly access the web server via <a>http://{zoraxy_host_ip}:<span class="webserv_port">8081</span></a> (Not recommended)
                    </div>
                    <br>
                </div>
                
            </div>
        </div>
    </div>
    
    <div class="ui divider"></div>
   
    <div class="ui basic segment">
        <h2>WebDAV Server</h2>
        <p>Manage your files in the web directory using WebDAV protocol</p>
    </div>
    <div class="ui form">
        <div class="ui basic segment webdavRunningStateWrapper">
            <h4 class="ui header" id="webdavRunningState">
                <i class="grey circle icon"></i>
                <div class="content">
                    <span class="webdav_status">Stopped</span>
                    <div class="sub header">Listen port :<span class="webdav_port">5488</span></div>
                </div>
            </h4>
        </div>
        <div class="inline field">
            <div class="ui toggle checkbox">
                <input id="webdav_enable" type="checkbox" class="hidden">
                <label>Enable WebDAV Server</label>
                <small>Notes: You still need to add a proxy rule to access the WebDAV server remotely.</small>
            </div>
        </div>
        <div class="field">
            <label>WebDAV Server Port</label>
            <input id="webdav_port" type="number" step="1" min="1" max="65535" value="5488">
            <small>WebDAV server listens only on localhost (127.0.0.1) for security reasons.</small>
        </div>
    </div>
    <br>
    <div class="ui message">
        <div class="ui accordion webdavhelp">
            <div class="title">
                <i class="dropdown icon"></i>
                How to access the WebDAV server?
            </div>
            <div class="content">
                <h4>Step 1: Add Proxy Rule</h4>
                <p>Add a new subdomain proxy rule (e.g., <code>webdav.example.com</code>) that points to <code>http://127.0.0.1:<span class="webdav_port">5488</span></code></p>
                
                <h4>Step 2: Connect with WebDAV Client</h4>
                <div class="ui list">
                    <div class="item">
                        <i class="windows icon"></i>
                        <div class="content">
                            <div class="header">Windows</div>
                            <div class="description">
                                Use <strong>WinSCP</strong> or map network drive:
                                <ol>
                                    <li>Open File Explorer</li>
                                    <li>Right-click "This PC" → "Map network drive"</li>
                                    <li>Enter: <code>\\webdav.example.com@SSL\</code> (or <code>http://webdav.example.com</code>)</li>
                                    <li>Use your Zoraxy admin username and password</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="item">
                        <i class="apple icon"></i>
                        <div class="content">
                            <div class="header">macOS</div>
                            <div class="description">
                                Use <strong>Finder → Go → Connect to Server</strong>:
                                <ol>
                                    <li>Press <kbd>Cmd</kbd>+<kbd>K</kbd></li>
                                    <li>Enter: <code>https://webdav.example.com</code></li>
                                    <li>Click "Connect" and enter your Zoraxy admin credentials</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="item">
                        <i class="linux icon"></i>
                        <div class="content">
                            <div class="header">Linux</div>
                            <div class="description">
                                Use your file manager's "Connect to Server" feature or mount with <code>davfs2</code>:
                                <br><code>mount -t davfs https://webdav.example.com /mnt/webdav</code>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h4>Important Notes</h4>
                <ul>
                    <li>Use HTTPS (SSL/TLS) for secure connections</li>
                    <li>Authenticate with your Zoraxy admin username and password</li>
                    <li>The WebDAV server serves the entire <code>www/</code> folder, including both <code>html/</code> (static web files) and <code>templates/</code> (Zoraxy templates)</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        $(".webservhelp").accordion();
        $(".webdavhelp").accordion();
        $(".ui.checkbox").checkbox();

        function setWebServerRunningState(running){
            if (running){
                $("#webserv_enable").parent().checkbox("set checked");
                $("#webservRunningState").find("i").attr("class", "white circle check icon");
                $("#webservRunningState").find(".webserv_status").text("Running");
                $(".webservRunningStateWrapper").addClass("enabled")
            }else{
                $("#webserv_enable").parent().checkbox("set unchecked");
                $("#webservRunningState").find("i").attr("class", "white circle times icon");
                $("#webservRunningState").find(".webserv_status").text("Stopped");
                $(".webservRunningStateWrapper").removeClass("enabled")
            }
        }

        function setWebDAVServerRunningState(running){
            if (running){
                $("#webdav_enable").parent().checkbox("set checked");
                $("#webdavRunningState").find("i").attr("class", "white circle check icon");
                $("#webdavRunningState").find(".webdav_status").text("Running");
                $(".webdavRunningStateWrapper").addClass("enabled")
            }else{
                $("#webdav_enable").parent().checkbox("set unchecked");
                $("#webdavRunningState").find("i").attr("class", "white circle times icon");
                $("#webdavRunningState").find(".webdav_status").text("Stopped");
                $(".webdavRunningStateWrapper").removeClass("enabled")
            }
        }

        function updateWebServState(){
            $.get("/api/webserv/status", function(data){
                //Clear all event listeners
                $("#webserv_enableDirList").off("change");
                $("#webserv_enable").off("change");
                $("#webserv_listenPort").off("change");
                $("#webdav_enable").off("change");
                $("#webdav_port").off("change");

                setWebServerRunningState(data.Running);

                if (data.EnableDirectoryListing){
                    $("#webserv_enableDirList").parent().checkbox("set checked");
                }else{
                    $("#webserv_enableDirList").parent().checkbox("set unchecked");
                }

                $("#webserv_docRoot").val(data.WebRoot + "/html/");

                if (!data.EnableWebDirManager){
                    $("#webdirManDisabledNotice").show();
                    $("#webserv_dirManager").remove();
                }

                if (!data.DisableListenToAllInterface){
                    //Options on UI is flipped
                    $("#webserv_enableAllInterfaces").parent().checkbox("set checked");
                }else{
                    $("#webserv_enableAllInterfaces").parent().checkbox("set unchecked");
                }

                $("#webserv_listenPort").val(data.ListeningPort);
                updateWebServLinkExample(data.ListeningPort);

                //WebDAV settings
                setWebDAVServerRunningState(data.EnableWebDAV);
                
                $("#webdav_port").val(data.WebDAVPort);
                updateWebDAVPortExample(data.WebDAVPort);

                //Bind checkbox events
                $("#webserv_enable").off("change").on("change", function(){
                    let enable = $(this)[0].checked;
                    if (enable){
                        $.get("/api/webserv/start", function(data){
                            if (data.error != undefined){
                                msgbox(data.error, false);
                            }else{
                                msgbox("Static web server started");
                                setWebServerRunningState(true);
                            }
                        });
                    }else{
                        $.get("/api/webserv/stop", function(data){
                            if (data.error != undefined){
                                msgbox(data.error, false);
                            }else{
                                msgbox("Static web server stopped");
                                setWebServerRunningState(false);
                            }
                        });
                    }
                });

                $("#webdav_enable").off("change").on("change", function(){
                    let enable = $(this)[0].checked;
                    if (enable){
                        $.get("/api/webserv/webdav/start", function(data){
                            if (data.error != undefined){
                                msgbox(data.error, false);
                                setWebDAVServerRunningState(false);
                            }else{
                                msgbox("WebDAV server started");
                                setWebDAVServerRunningState(true);
                            }
                        });
                    }else{
                        $.get("/api/webserv/webdav/stop", function(data){
                            if (data.error != undefined){
                                msgbox(data.error, false);
                                setWebDAVServerRunningState(true);
                            }else{
                                msgbox("WebDAV server stopped");
                                setWebDAVServerRunningState(false);
                            }
                        });
                    }
                });

                $("#webserv_enableDirList").off("change").on("change", function(){
                    let enable = $(this)[0].checked;
                    $.cjax({
                        url: "/api/webserv/setDirList",
                        method: "POST",
                        data: {"enable": enable},
                        success: function(data){
                            if (data.error != undefined){
                                msgbox(data.error, false);
                            }else{
                                msgbox("Directory listing setting updated");
                            }
                        }
                    })
                });

                $("#webserv_enableAllInterfaces").off("change").on("change", function(){
                    let disable = !$(this)[0].checked;
                    $.cjax({
                        url: "/api/webserv/disableListenAllInterface",
                        method: "POST",
                        data: {"disable": disable},
                        success: function(data){
                            if (data.error != undefined){
                                msgbox(data.error, false);
                            }else{
                                msgbox("Listening interface setting updated");
                            }
                        }
                    })
                });

                $("#webserv_listenPort").off("change").on("change", function(){
                    let newPort = $(this).val();

                    //Check if the new value is same as listening port
                    let rpListeningPort = $("#incomingPort").val();
                    if (rpListeningPort == newPort){
                        confirmBox("This setting might cause port conflict. Continue Anyway?", function(choice){
                            if (choice == true){
                                //Continue anyway
                                $.cjax({
                                    url: "/api/webserv/setPort",
                                    method: "POST",
                                    data: {"port": newPort},
                                    success: function(data){
                                        if (data.error != undefined){
                                            msgbox(data.error, false);
                                        }else{
                                            msgbox("Listening port updated");
                                        }
                                        updateWebServState();
                                    }
                                });
                            }else{
                                //Cancel. Restore to previous value
                                updateWebServState();
                                msgbox("Setting restored");
                            }
                        });
                    }else{
                        $.cjax({
                            url: "/api/webserv/setPort",
                            method: "POST",
                            data: {"port": newPort},
                            success: function(data){
                                if (data.error != undefined){
                                    msgbox(data.error, false);
                                }else{
                                    msgbox("Listening port updated");
                                }
                            }
                        })
                    }
                });

                $("#webdav_port").off("change").on("change", function(){
                    let newPort = $(this).val();
                    $.cjax({
                        url: "/api/webserv/webdav/setPort",
                        method: "POST",
                        data: {"port": newPort},
                        success: function(data){
                            if (data.error != undefined){
                                msgbox(data.error, false);
                            }else{
                                msgbox("WebDAV port updated");
                                updateWebDAVPortExample(newPort);
                            }
                        }
                    })
                });
            })
        }
        updateWebServState();

        function updateWebServLinkExample(newport){
            $(".webserv_port").text(newport);
        }

        function updateWebDAVPortExample(newport){
            $(".webdav_port").text(newport);
        }
    </script>
</div>