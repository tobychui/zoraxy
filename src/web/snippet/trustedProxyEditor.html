<!DOCTYPE html>
<html>
  <head>
      <!-- Notes: This should be open in its original path-->
      <meta charset="utf-8">
      <meta name="zoraxy.csrf.Token" content="{{.csrfToken}}">
      <link rel="stylesheet" href="../script/semantic/semantic.min.css">
      <script src="../script/jquery-3.6.0.min.js"></script>
      <script src="../script/semantic/semantic.min.js"></script>
      <script src="../script/utils.js"></script>
      <style>

      </style>
  </head>
  <body>
    <link rel="stylesheet" href="../darktheme.css">
    <script src="../script/darktheme.js"></script>
    <br>
    <div class="ui container">
        <div class="ui header">
            <i class="ui green shield alternate icon"></i>
            <div class="content">
                Trusted Proxy Settings
                <div class="sub header">Add, edit or remove trusted proxy IPs or CIDRs</div>
            </div>
        </div>
        <div class="ui divider"></div>
        <!-- Add new trusted proxy form -->
        <h4>Add Trusted Proxy</h4>
        <div class="ui form">
            <div class="two fields">
                <div class="field">
                    <label>IP Address / CIDR</label>
                    <input type="text" id="trustedProxyIpInput" placeholder="e.g. 103.21.244.0/22 or 192.168.1.1">
                    <small>Supports single IP addresses and CIDR notation (e.g. 192.168.1.0/24 or 192.168.1.1)</small>
                </div>
                <div class="field">
                    <label>Description</label>
                    <input type="text" id="trustedProxyDescInput" placeholder="e.g. Cloudflare">
                </div>
            </div>
            <button class="ui basic green button" onclick="addTrustedProxy();">
                <i class="ui green add icon"></i> Add Trusted Proxy
            </button>
        </div>
        <br>
        <div class="ui divider"></div>
        <button id="refreshProxyListBtn" class="ui circular right floated basic icon button" onclick="initTrustedProxyTable();"><i class="ui green refresh icon"></i></button>
        <!-- Trusted proxy table -->
        <h4>Trusted Proxy List </h4>
        <p>You can also edit the <code>conf/trusted_proxies.json</code> file directly for bulk updates.</p>
        <table class="ui unstackable basic celled table">
            <thead>
                <tr>
                    <th>IP / CIDR</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="trustedProxyTable">
            </tbody>
        </table>
        <br>
        
        <button class="ui basic button" style="float: right;" onclick="parent.hideSideWrapper();"><i class="remove icon"></i> Close</button>
        <br><br><br>
    </div>

    <script>
        // Initialize trusted proxy table
        function initTrustedProxyTable(){
            $.get('/api/trustedproxy/list', function(data) {
                $('#trustedProxyTable').html("");
                if (!data || data.length === 0) {
                    $('#trustedProxyTable').append(`
                    <tr>
                        <td colspan="3"><i class="yellow warning icon"></i>No trusted proxies configured</td>
                    </tr>
                    `);
                } else {
                    $.each(data, function(index, proxy) {
                        let ip = proxy.IP;
                        let desc = proxy.Desc || '';
                        let icon = ip.includes('/') ? "angle double right blue icon" : "angle double right green icon";
                        $('#trustedProxyTable').append(`
                            <tr class="trustedProxyItem" data-ip="${encodeURIComponent(ip)}">
                                <td class="proxy-ip-cell">
                                    <i class="${icon} proxy-icon"></i>
                                    <span class="proxy-ip-display">${ip}</span>
                                    <div class="ui mini fluid input proxy-ip-edit" style="display:none;">
                                        <input type="text" value="${ip}">
                                    </div>
                                </td>
                                <td class="proxy-desc-cell">
                                    <span class="proxy-desc-display">${desc}</span>
                                    <div class="ui mini fluid input proxy-desc-edit" style="display:none;">
                                        <input type="text" value="${desc}">
                                    </div>
                                </td>
                                <td>
                                    <div class="proxy-actions-display">
                                        <button class="ui icon basic mini blue button" onclick="editTrustedProxyRow(this);" title="Edit">
                                            <i class="edit icon"></i>
                                        </button>
                                        <button class="ui icon basic mini red button" onclick="removeTrustedProxy('${ip}');" title="Delete">
                                            <i class="trash alternate icon"></i>
                                        </button>
                                    </div>
                                    <div class="proxy-actions-edit" style="display:none;">
                                        <button class="ui icon basic mini green button" onclick="saveTrustedProxyRow(this, '${ip}');" title="Save">
                                            <i class="check icon"></i>
                                        </button>
                                        <button class="ui icon basic mini grey button" onclick="cancelTrustedProxyEdit(this);" title="Cancel">
                                            <i class="times icon"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });
                }
            });
        }
        initTrustedProxyTable();

        // Add a new trusted proxy
        function addTrustedProxy(){
            let ip = $('#trustedProxyIpInput').val().trim();
            let desc = $('#trustedProxyDescInput').val().trim();

            if (ip == ''){
                parent.msgbox("Please enter an IP address or CIDR", false);
                return;
            }

            $.cjax({
                type: 'POST',
                url: '/api/trustedproxy/add',
                data: { ip: ip, desc: desc },
                success: function(data){
                    if (data.error != undefined){
                        parent.msgbox("Failed to add trusted proxy: " + data.error, false);
                        return;
                    }
                    parent.msgbox("Trusted proxy added", true);
                    $('#trustedProxyIpInput').val('');
                    $('#trustedProxyDescInput').val('');
                    initTrustedProxyTable();
                }
            });
        }

        // Remove a trusted proxy
        function removeTrustedProxy(ip){
            if (!confirm("Are you sure you want to remove this trusted proxy?")){
                return;
            }

            $.cjax({
                type: 'POST',
                url: '/api/trustedproxy/remove',
                data: { ip: ip },
                success: function(data){
                    if (data.error != undefined){
                        parent.msgbox("Failed to remove trusted proxy: " + data.error, false);
                        return;
                    }
                    parent.msgbox("Trusted proxy removed", true);
                    initTrustedProxyTable();
                }
            });
        }

        // Edit trusted proxy row - switch to edit mode
        function editTrustedProxyRow(btn){
            let row = $(btn).closest('tr');
            row.find('.proxy-icon, .proxy-ip-display, .proxy-desc-display, .proxy-actions-display').hide();
            row.find('.proxy-ip-edit, .proxy-desc-edit, .proxy-actions-edit').show();
            row.find('.proxy-ip-edit input').focus();
        }

        // Cancel editing a trusted proxy row
        function cancelTrustedProxyEdit(btn){
            let row = $(btn).closest('tr');
            row.find('.proxy-ip-edit input').val(row.find('.proxy-ip-display').text());
            row.find('.proxy-desc-edit input').val(row.find('.proxy-desc-display').text());
            row.find('.proxy-icon, .proxy-ip-display, .proxy-desc-display, .proxy-actions-display').show();
            row.find('.proxy-ip-edit, .proxy-desc-edit, .proxy-actions-edit').hide();
        }

        // Save edited trusted proxy row
        function saveTrustedProxyRow(btn, originalIp){
            let row = $(btn).closest('tr');
            let newIp = row.find('.proxy-ip-edit input').val().trim();
            let newDesc = row.find('.proxy-desc-edit input').val().trim();

            if (newIp == ''){
                parent.msgbox("IP address cannot be empty", false);
                return;
            }

            $.cjax({
                type: 'POST',
                url: '/api/trustedproxy/update',
                data: { 
                    original_ip: originalIp,
                    new_ip: newIp,
                    desc: newDesc
                },
                success: function(data){
                    if (data.error != undefined){
                        parent.msgbox("Failed to update trusted proxy: " + data.error, false);
                        return;
                    }
                    parent.msgbox("Trusted proxy updated", true);
                    initTrustedProxyTable();
                }
            });
        }
    </script>
</body>
</html> 